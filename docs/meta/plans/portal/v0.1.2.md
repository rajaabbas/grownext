# Portal v0.1.2 Plan

> This plan rolls up under the billing enablement epic (`docs/meta/plans/epics/billing-epic-v0.1.2.md`).

## Goals
- Introduce a first-class billing module in the portal that surfaces subscription status, usage, and invoices without leaving the tenancy experience.
- Provide tenants with actionable controls for managing plans, payment methods, and billing contacts while respecting existing permission boundaries.
- Surface usage telemetry (including AI token consumption) to help customers stay within plan limits and reduce support escalations.

## Scope
1. **Information Architecture**
   - Add persistent billing navigation entry in `apps/portal/components/portal-header.tsx` and contextual breadcrumbs in new billing routes.
   - Extend portal layout guards (`apps/portal/app/(portal)/layout.tsx`) to gate billing access behind `organization:billing`.
   - Document updated navigation map in `docs/architecture/overview.md` and ensure cross-links from admin docs reference the new portal billing screens.
2. **Billing Overview Dashboard**
   - Create `apps/portal/app/(portal)/billing/page.tsx` with plan summary card, payment status, renewal date, and quick actions for upgrades/downgrades.
   - Display feature limit utilization (seats, tenants, AI tokens) using shared chart primitives from `@ma/ui`.
   - Wire data via new identity endpoint (`GET /portal/billing/overview`) exposed through `fetchPortalBillingOverview` helper in `@ma/identity-client`.
3. **Usage & AI Metering**
   - Build tabbed usage reports (`apps/portal/app/(portal)/billing/usage/page.tsx`) that show daily aggregates, with filters for products and AI models.
   - Integrate usage event stream with periodic refresh and CSV export, leaning on worker-generated rollups.
   - Surface alert states when utilization exceeds 80%, and link to documentation for remediation.
4. **Plan Management & Self-Service**
   - Implement plan comparison modal that reads package catalog from identity and clearly lists entitlements.
   - Support upgrade/downgrade requests by posting to `POST /portal/billing/subscription/change` and confirming results with optimistic UI.
   - Capture billing contacts and tax identifiers via editable form stored through identity APIs.
5. **Invoices & Payments**
   - Add invoice history table with filters, download links, and payment status badges (`apps/portal/app/(portal)/billing/invoices/page.tsx`).
   - Provide pay-now CTA (when enabled) that redirects users to processor-hosted checkout or triggers payment intent via identity.
   - Ensure failed payment states surface prominent alerts and action steps.
6. **Observability & Security**
   - Log key billing interactions via existing telemetry provider; extend `apps/portal/app/api` route handlers to include audit context.
   - Add e2e coverage in `apps/e2e/tests/portal/billing.spec.ts` for happy path and permission-denied flows.
   - Update docs in `docs/operations` with runbooks for billing incident response and usage data reconciliation.

## Dependencies
- Identity v0.1.2 plan: billing schema, subscription APIs, usage aggregation (`docs/meta/plans/identity/v0.1.2.md`).
- Admin v0.1.2 plan: shared billing catalog editor and audit visibility (`docs/meta/plans/admin/v0.1.2.md`).
- Worker v0.1.2 plan: daily invoice generation, AI token aggregation jobs (`docs/meta/plans/worker/v0.1.2.md`).
- Contracts package: new billing DTOs consumed by portal (`packages/contracts/src/billing/*.ts`).

## Non-Goals
- Implementing payment provider onboarding flows (handled in identity/backoffice).
- Introducing configurable discount logic inside the portal UI; display-only for discounts issued elsewhere.
- Delivering mobile parity; focus remains on desktop tenants.

## Deliverables & Milestones
1. **Week 1:** Wireframe approval, navigation updates, high-level overview page stub with mocked data.
2. **Week 2:** Identity client integration, plan comparison, subscription change workflows, write docs for updated portal flows.
3. **Week 3:** Usage reporting, AI token visualization, invoice table with downloads.
4. **Week 4:** Observability, e2e coverage, performance sweeps, doc updates, stakeholder review.

## Testing & Quality
- Unit tests for new React server components and hooks (Vitest + Testing Library).
- Contract tests ensuring identity billing responses deserialize correctly in `@ma/identity-client`.
- Playwright coverage for billing happy paths, permission denial, and error retries.
- Accessibility checks (jest-axe) on new tables/charts; ensure focus order and keyboard navigation are compliant.

## Rollout Notes
- Keep feature flag (`portal.billing.enabled`) to dark-launch UI; enable per-tenant after data backfill.
- Announce availability in release notes; instruct support to monitor billing ticket queue post-launch.
- After completion, bump `apps/portal/package.json` to **0.1.2** and archive this plan next to release notes.
