# Billing v0.1.3 Plan â€“ Completion & Operational Readiness

## Goals
- Ship the remaining billing capabilities required for customer rollout: real payment provider integration, admin tooling, product-side usage emitters, and operational playbooks.
- Harden background processing (metrics, manual tooling) so finance/support teams can diagnose issues quickly and run backfills safely.
- Close QA and documentation gaps ahead of feature flag enablement beyond internal tenants.

## Scope
1. **Payment Provider Integration**
   - Implement Stripe (or chosen provider) adapter in `apps/identity/src/lib/billing/payment-provider.ts` including customer sync, payment method vault updates, and intent creation.
   - Add webhook signature validation and handlers for payment success/failure/dispute/refund events; ensure they dispatch to worker queues.
   - Document provider configuration, secret management, and replay procedures in `docs/operations/runbooks/identity.md`.

2. **Worker Enhancements**
   - Extend billing processors with metrics (processed counts, duration, failure rates) exported to the existing logging/metrics pipeline.
   - Add CLI/backfill tooling (`apps/worker/src/enqueue.ts` or new scripts) to trigger usage recomputes, invoice regeneration, and payment sync retries.
   - Introduce idempotency safeguards (job dedupe keys, retry policies, DLQ review guidance).

3. **Admin Console Billing Surfaces**
   - Build admin routes/pages for catalog management, subscription inspection, invoice review, credit issuance, and usage exploration.
   - Gate behind `ADMIN_BILLING_ENABLED`, with role/permission checks and audit logging.
   - Integrate with `@ma/identity-client` admin billing helpers; add tables/forms using shared UI primitives.

4. **Product Usage Instrumentation**
   - Wire Tasks/AI services to emit usage events to `/internal/billing/usage/events`, including tenant/product metadata and batching/throttling.
   - Provide backfill scripts for historical usage (per product) and add monitoring around dropped events.
   - Document SDK/example usage in product repos and shared docs.

5. **QA, Ops, and Docs**
   - Add Playwright end-to-end scenarios covering portal billing flows (overview, usage filters, plan change, payment method update) and admin finance workflows.
   - Run load tests against usage ingestion and invoice generation; capture results and tuning recommendations.
   - Update runbooks (`docs/operations/runbooks/*.md`), architecture diagrams, and publish release notes for v0.1.3 across portal/admin/identity/worker.

## Dependencies
- Current billing foundations from v0.1.2 (schema, contracts, identity routes, worker processors, portal UI).
- Stripe (or alternative provider) sandbox credentials.
- Product teams ready to add instrumentation hooks.
- Existing logging/metrics infrastructure for worker telemetry.

## Out of Scope
- Multi-provider payment abstraction beyond the initial adapter.
- Customer-facing email templates for invoices/alerts (handled by notifications team).
- Long-term analytics dashboards (future phase once data warehouse integration is planned).

## Deliverables & Timeline
| Week | Deliverables |
| --- | --- |
| Week 1 | Payment provider adapter + webhook handlers; worker metrics instrumentation scaffold. |
| Week 2 | Worker CLI/backfill tools; admin console billing pages (catalog + subscriptions). |
| Week 3 | Product usage emitters, backfill scripts, remaining admin surfaces (invoices, usage explorer). |
| Week 4 | Playwright/E2E + load tests, ops runbooks, release notes; staging dry run with real provider sandbox. |

## Testing & Validation
- Unit tests for payment provider adapter, webhook parsing, worker CLI helpers.
- Integration tests hitting identity routes and ensuring worker jobs process simulated provider events.
- Playwright suites for portal/admin flows (happy paths + permission denials).
- Load/regression runs on queues with synthetic data; verify idempotency under retries.

## Rollout Plan
1. Deploy new code behind existing feature flags; keep provider secrets disabled in production until sandbox validation passes.
2. Run staging end-to-end exercises with finance/support sign-off (mock customers, invoice generation, payment lifecycle).
3. Enable `ADMIN_BILLING_ENABLED` for internal finance group; monitor logs/metrics.
4. Gradually enable `PORTAL_BILLING_ENABLED` and `WORKER_BILLING_ENABLED` for pilot tenants once emitters/backfills complete.
5. Publish runbooks and release notes; announce general availability once telemetry shows steady-state success.

