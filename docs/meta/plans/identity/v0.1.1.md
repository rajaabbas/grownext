# Identity v0.1.1 Plan

## Goals
- Back bulk job execution with resilient queues and status tracking.
- Expand audit APIs to support diff views and impersonation stop events.
- Tighten security around impersonation tokens (revocation, expiry).

## Scope
1. **Bulk job worker integration**
   - Move job execution into BullMQ queue processed by `@ma/worker`.
   - Publish incremental progress updates (completed/failed IDs) over Redis.
   - Expose `PATCH /super-admin/bulk-jobs/:id` for retry/cancel actions.
2. **Audit log enhancements**
   - Include before/after payloads for entitlement changes.
   - Emit `IMPERSONATION_STOPPED` events when sessions end or expire.
   - Support diff-ready metadata for portal display.
3. **Impersonation token lifecycle**
   - Add `DELETE /super-admin/users/:id/impersonation/:tokenId`.
   - Enforce single active session per admin/user pair.
   - Rotate signing secret configurable via env (`SUPER_ADMIN_IMPERSONATION_SECRET`).
4. **Downstream notifications**
   - Emit webhook events when bulk jobs complete (success/failure/export link) for portal/tasks consumption.
   - Broadcast impersonation start/stop events so UI surfaces accurate banners.

## Dependencies
- Requires worker changes for queue processing (`docs/meta/plans/worker/v0.1.1.md`).
- Admin UI expects new endpoints/events (`docs/meta/plans/admin/v0.1.1.md`).
- Portal and Tasks apps rely on webhook payloads (`docs/meta/plans/portal/v0.1.1.md`, `docs/meta/plans/tasks/v0.1.1.md`).

## Testing
- Extend route tests for new endpoints and error paths.
- Add integration test that runs a bulk job end-to-end using a test queue.
- Verify Prisma migrations create required indices and foreign keys.

## Release Notes
- Update `apps/identity/package.json` to **0.1.1** once features are complete.
- Document new env vars (`SUPER_ADMIN_IMPERSONATION_SECRET`) in `docs/reference/env-vars.md`.
