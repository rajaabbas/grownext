# Base Apps Hardening – Identity Plan (v0.2.0)

> Status: 📝 Draft (Oct 2025). Aligned with the Oct 23 identity hardening sprint in `docs/meta/roadmap.md`.
>
> Manual rollback drills and shared QA notes now live in `docs/meta/plans/identity/v0.2.3.md`.

## Goals
- Tighten identity access controls and tenant isolation ahead of the condensed launch window.
- Strengthen rate limiting, auditing, and rollback tooling to raise operational confidence.
- Deliver updated documentation and smoke automation so downstream apps can ship safely on Oct 23–31.

## Scope
1. **Access Controls & Auditing *(Status: 📝 Draft – Oct 2025)***
   - [x] Enforce tenant-scoped guards across `/portal/*`, `/admin/*`, and internal product routes.
   - [x] Add structured audit exports for newly protected endpoints and impersonation flows.
   - [x] Review SDK consumers (`@ma/identity-client`) for required header/payload updates.
2. **Resilience & Incident Readiness *(Status: 📝 Draft – Oct 2025)***
   - [x] Tune default rate limits and throttle policies; document overrides and rollback steps.
   - [x] Build automated smoke pipeline executed post-deploy and on demand; capture success/failure hooks.
   - [x] Finalize incident response checklist covering auth regressions and tenant isolation failures.
3. **Session Lifecycle Hardening *(Status: 📝 Draft – Oct 2025)***
   - [x] Validate refresh-token propagation, 2FA edge cases, and impersonation expiry handling.
   - [x] Coordinate with portal/admin to update messaging for session-state changes.
   - [x] Provide worker with guidance for handling token expiry within queue consumers.

## Dependencies
- Portal/admin PRs consuming updated identity-client helpers.
- Worker queue changes to accommodate new token expiry semantics.
- Runbook updates from support/ops to incorporate the revised incident checklist.

## Testing & Validation
 - [x] Vitest coverage for new auth guards, audit exports, and throttle helpers.
- [x] Integration suite ensuring portal/admin critical paths honor tightened access controls. _(Automation owner: Codex; exercised via new coverage in `apps/identity/src/server.test.ts` validating portal launcher auth and admin scope guards, see `pnpm --filter @ma/identity test`.)_
- [x] Playwright smoke (triggered via automation pipeline) verifying login, impersonation, and tenant switching. _(Executed via CI.)_
- [x] Manual rollback drill documented with timings and owner sign-off. _(Tracked under v0.2.3 manual validation.)_

## Documentation
 - [x] Update identity runbook with new throttle defaults and smoke automation instructions.
 - [x] Refresh security FAQ and onboarding docs to reflect tenant guardrails.
 - [x] Add release notes summarizing v0.2.0 changes for downstream teams.
