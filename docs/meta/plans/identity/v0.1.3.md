# Billing v0.1.3 Plan – Identity Service

> This plan rolls up under the billing epic (`docs/meta/plans/epics/billing-epic-v0.1.3.md`).

## Goals
- Harden payment provider integration (Stripe) for customer-ready billing flows.
- Ensure identity exposes the required billing APIs/webhooks with observability and safety nets.
- Provide clear operational guidance for finance/support teams.

## Scope
1. **Stripe Provider Hardening *(Status: ✅ Completed — Oct 2025)***
   - Sync customers/payment methods with deleted-customer recovery and metadata typing.
   - Validate webhooks (signature, dispute/refund handling) and enqueue payment sync jobs.
   - Surface ingestion drop warnings for `/internal/billing/usage/events`.
2. **Billing API Enhancements *(Status: ✅ Completed — Oct 2025)***
   - `/portal/billing/*` and `/super-admin/billing/*` routes with authz + auditing.
   - Credit issuance endpoints wired to Stripe + worker processors.
3. **Operational Docs *(Status: ✅ Completed — Oct 2025)***
   - Update identity runbook with billing ingest monitoring + webhook replay steps.

## Remaining Work
- [ ] Deferred to v0.1.4 Tasks Launch Readiness: execute billing load tests alongside worker (`pnpm --filter @ma/worker billing:load-test ...`) and capture metrics once scheduled.

## Dependencies
- Stripe sandbox credentials (`IDENTITY_PAYMENT_PROVIDER_API_KEY`, webhook secret).
- Worker queue availability (`billing-payment-sync`, `billing-invoice`).
- Portal/admin consumers on v0.1.3 clients.

## Rollout Notes
1. Enable billing feature flags after staging validation (`IDENTITY_BILLING_ENABLED`, `WORKER_BILLING_ENABLED`).
2. Ensure webhook secrets match between Stripe and `IDENTITY_PAYMENT_PROVIDER_WEBHOOK_SECRET`.
3. Monitor identity logs for `billing_usage_event_drop` warnings during rollout.

## Testing & Validation
- Vitest coverage for payment provider module + webhook handler.
- Integration tests covering billing routes with mocked services.
- Manual webhook replay dry run in staging before enabling production webhooks.
- Additional identity-client unit tests verifying Authorization header propagation for billing routes.
