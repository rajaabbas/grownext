# Identity v0.1.2 Plan

> This plan rolls up under the billing enablement epic (`docs/meta/plans/epics/billing-epic-v0.1.2.md`).

## Goals
- Establish subscription, usage, and invoicing primitives inside the identity control plane so billing data stays authoritative and tenant-aware.
- Expose secure APIs that power the portal billing module and internal admin tooling, including payment status and plan management flows.
- Instrument AI token usage and other consumption signals so downstream rating and invoice generation is reliable and auditable.

## Scope
1. **Schema & Seed Expansion**
   - Extend `packages/db/prisma/schema.prisma` with package catalog, feature limits, subscription, pricing, usage event, invoice, payment method, and credit memo tables (including history/audit fields).
   - Generate migrations plus type-safe Prisma client accessors in `packages/db/src` (e.g., `billing-packages.ts`, `subscriptions.ts`, `usage-events.ts`, `invoices.ts`) with transactional helpers.
   - Update seed script (`packages/db/prisma/seed.ts`) to register baseline packages, feature limits, and demo invoices for local development.
2. **Contracts & SDK Alignment**
   - Add billing DTOs and enums under `packages/contracts/src/billing/*`, exporting through `packages/contracts/src/index.ts` with schema validation.
   - Extend `packages/identity-client/src/http.ts` to surface new portal and admin billing endpoints (`fetchPortalBillingOverview`, `fetchBillingUsage`, `updateSubscription`, `listInvoices`, etc.).
   - Publish queue constants for billing usage/invoice jobs in `packages/core/src/queues.ts` to keep worker and identity aligned.
3. **Portal-Facing APIs**
   - Introduce a dedicated router (`apps/identity/src/routes/portal/billing.ts`) that serves overview, usage summaries, subscription mutations, billing contact updates, and invoice listings scoped to the authenticated organization.
   - Honor `organization:billing` permission checks and include audit logging to `AuditEvent` for each mutation.
4. **Admin & Internal APIs**
   - Create `apps/identity/src/routes/super-admin/billing.ts` (and supporting lib services) for package CRUD, customer subscription overrides, credit issuance, and invoice reconciliation.
   - Add internal endpoints for worker callbacks (`/internal/billing/invoice-created`, `/internal/billing/payment-webhook`) to track background job outcomes.
5. **Billing Domain Services**
   - Implement domain modules under `apps/identity/src/lib/billing/*` handling subscription lifecycle (activate, schedule change, cancel), pricing evaluation, and invoice rating.
   - Support proration logic, minimum commitments, and tax calculation placeholders with configuration stored in the new schema.
6. **Usage & AI Token Intake**
   - Provide authenticated ingestion endpoints/queue publishers (`/internal/usage/events`) that accept usage payloads from product apps and AI services, normalizing metadata (tenant, feature, model).
   - Store raw events plus pre-aggregated daily rollups ready for worker processing; ensure idempotency via event fingerprints.
   - Document SDK guidance for submitting usage events from Tasks/AI helpers.
7. **Payment Provider Integration**
   - Build pluggable payment adapter (`apps/identity/src/plugins/payments/*`) supporting initial provider (e.g., Stripe) with webhook signature validation and customer vault management.
   - Schedule reconciliation job triggers for worker when webhooks indicate payment changes or dispute events.
8. **Observability & Docs**
   - Emit structured logs and metrics for billing flows (subscription state changes, webhook handling) via `@ma/core` logger.
   - Update runbooks (`docs/operations/runbooks/identity.md`) with billing incident response, webhook replay steps, and invoice troubleshooting.
   - Refresh architecture docs (`docs/architecture/overview.md`) to describe billing data flow and new queues.

## Dependencies
- Worker v0.1.2 plan for aggregation, invoice generation, and payment sync (`docs/meta/plans/worker/v0.1.2.md`).
- Portal v0.1.2 plan for UI consumption of new APIs (`docs/meta/plans/portal/v0.1.2.md`).
- Admin v0.1.2 plan for package catalog and finance tooling (`docs/meta/plans/admin/v0.1.2.md`).
- Contracts update must land before portal/admin integration; coordinate version bumps across `@ma/contracts` and `@ma/identity-client`.

## Non-Goals
- Implementing multiple payment providers; focus on a single adapter abstraction with documented extension points.
- Supporting per-seat licensing enforcement at product runtime (handled by product apps once usage data is available).
- Delivering customer-facing billing email templates (to be scoped later with marketing).

## Deliverables & Milestones
1. **Week 1:** Finalize data model, migrations, seed updates, and contract scaffolding.
2. **Week 2:** Implement portal APIs, domain services, and initial subscription lifecycle flows.
3. **Week 3:** Wire admin/internal endpoints plus payment adapter with webhook handling.
4. **Week 4:** Complete usage ingestion path, observability, doc updates, and readiness review.

## Testing & Quality
- Expand Vitest coverage for new lib modules (rating, subscription transitions) with scenario-based fixtures.
- Add supertest API suites for portal/admin billing routes (authz checks, happy/error paths).
- Create integration harness that simulates usage events → worker rollup → invoice callback to ensure idempotency.
- Run load tests against usage ingestion to validate batching and database indexing.

## Rollout Notes
- Protect APIs behind feature flag (`IDENTITY_BILLING_ENABLED`) and gradual rollout by tenant cohort.
- Maintain migration guardrails: run migrations in staging with anonymized prod snapshot before production apply.
- After completion, bump `apps/identity/package.json` to **0.1.2** concurrently with `@ma/db`, `@ma/contracts`, and `@ma/identity-client` minor bumps; archive this plan alongside release notes.
