# Admin v0.1.2 Plan

## Goals
- Provide finance and support teams with authoritative tooling to manage billing packages, monitor subscriptions, and intervene on invoices.
- Offer deep visibility into usage aggregates and AI token consumption to validate charges before invoices reach customers.
- Ensure operational workflows (credits, refunds, payment failures) are auditable and tightly coupled to identity billing services.

## Scope
1. **Navigation & IA Updates**
   - Introduce a “Billing” primary nav section in `apps/admin/lib/navigation.ts` and extend layout breadcrumbs for new routes under `apps/admin/app/(authenticated)/billing/*`.
   - Update role guard logic to require `super-admin` by default while allowing configurable finance/support roles once identity exposes them.
2. **Package Catalog Management**
   - Build catalog list/editor pages (`.../billing/packages/page.tsx`, `.../billing/packages/[packageId]/page.tsx`) using `@ma/ui` tables + forms to CRUD package metadata, feature limits, and pricing.
   - Leverage new identity endpoints (`/super-admin/billing/packages`) via helpers added to `apps/admin/app/api/super-admin/billing/*`.
   - Provide diff + preview output so changes can be reviewed before publishing (ties into identity migrations).
3. **Subscription Oversight**
   - Create organization-level dashboard (`.../billing/subscriptions/[organizationId]/page.tsx`) showing active plans, scheduled changes, add-ons, and billing contacts.
   - Support manual adjustments (credits, overrides) through POST/PATCH requests to identity; require confirmation modals and audit reason capture.
4. **Invoice & Payment Operations**
   - Implement invoice index/detail pages (`.../billing/invoices/page.tsx`, `.../billing/invoices/[invoiceId]/page.tsx`) with status filtering, PDF download links, and payment retry triggers.
   - Surface payment failures, disputes, and webhook statuses; allow finance team to mark invoices collected after manual reconciliation.
5. **Usage Analytics**
   - Add usage explorer (`.../billing/usage/page.tsx`) that visualizes aggregated consumption (seats, tenants, AI tokens) with filters by product, plan, and time window.
   - Incorporate alerts for over-limit tenants and export capability for finance review (CSV download using API proxy route).
6. **Support Tooling Enhancements**
   - Extend impersonation/bulk job context panels to show recent billing actions, drawing data from new identity audit events.
   - Provide quick links from user detail pages to associated organization billing panels.
7. **Docs & Communication**
   - Update `docs/operations/runbooks/admin.md` with billing workflows (package updates, invoice retries, credit issuance).
   - Add finance onboarding section to `docs/meta/automation.md` describing permissions required and release cadence for billing features.

## Dependencies
- Identity v0.1.2 endpoints for billing packages, subscriptions, invoices, and usage (`docs/meta/plans/identity/v0.1.2.md`).
- Worker v0.1.2 invoice and usage aggregation jobs for accurate data feeds (`docs/meta/plans/worker/v0.1.2.md`).
- Portal billing surfaces for customer-facing validation flows (`docs/meta/plans/portal/v0.1.2.md`).

## Non-Goals
- Building processor onboarding UI (handled in identity/backoffice scripts).
- Allowing direct payment method entry within the admin console; continue to rely on processor dashboards.
- Multi-currency presentation; scope limited to default currency with formatting from identity.

## Deliverables & Milestones
1. **Week 1:** Navigation updates, package catalog list/detail views wired to mocked data.
2. **Week 2:** Subscription oversight flows with identity integration and audit reason capture.
3. **Week 3:** Invoice operations + usage analytics with CSV export.
4. **Week 4:** Support panel enhancements, documentation updates, and QA sign-off.

## Testing & Quality
- Extend Vitest component tests for new tables/forms, covering validation and optimistic updates.
- Add Playwright scenarios verifying package edit, invoice retry, and usage explorer filtering (including permission denial).
- Ensure API route handlers exercise error states (identity timeouts, auth failures) with user-friendly toasts.

## Rollout Notes
- Gate new routes behind feature flag (`admin.billing.enabled`) until data backfill completes.
- Coordinate with finance team before publishing package updates from staging to production.
- After delivery, bump `apps/admin/package.json` to **0.1.2** and archive alongside release notes.
