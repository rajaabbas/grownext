# Base Apps Hardening â€“ Worker Plan (v0.2.0)

> Status: ğŸ“ Draft (Oct 2025). Ensures worker processors align with the Octâ€¯23 identity hardening updates.
>
> Manual soak tests, dashboard reviews, and smoke pipeline documentation live in `docs/meta/plans/worker/v0.2.3.md`.

## Goals
- Confirm worker queues continue to operate under stricter identity access controls and token expiry behavior.
- Improve observability and error handling for impersonation cleanup and notification jobs.
- Prepare the automation surface for the rest of the Octâ€¯23â€“31 sprint sequence.

## Scope
1. **Queue Compatibility *(Status: ğŸ“ Draft â€“ Oct 2025)***
   - [x] Validate billing, notification, and impersonation processors against identityâ€™s updated token/guardrail logic. _(Processors now inspect `IdentityHttpError` to distinguish throttling.)_
   - [x] Refresh service-role claim usage where identity-client headers or payloads changed.
2. **Observability & Logging *(Status: ğŸ“ Draft â€“ Oct 2025)***
   - [x] Add structured logs for impersonation cleanup and notification jobs to highlight guardrail-triggered failures.
   - [x] Update alert thresholds as needed to reflect tightened throughput expectations. _(Runbook highlights throttled log signatures.)_
3. **Docs & Automation *(Status: ğŸ“ Draft â€“ Oct 2025)***
   - [x] Capture any required tooling adjustments ahead of the Octâ€¯30 performance rehearsal. _(Logging updates for invoice/payment throttles.)_
   - [x] Sync CLI usage notes with support/runbook teams. _(Runbook augmented with throttling guidance.)_

## Dependencies
- Identity v0.2.0 deployment and revised identity-client helpers.
- Portal/admin feedback on impersonation or billing telemetry surfaced via worker.
- Tasks app validation for notification delivery under new auth conditions.

## Testing & Validation
- [x] Unit tests covering queue handlers affected by identity guardrails. _(Automation owner: Codex; new rate-limit cases in `apps/worker/src/processors/billing-{usage,payment-sync,invoice}.test.ts`, confirmed with `pnpm --filter @ma/worker test`.)_
- [x] End-to-end smoke run verifying billing usage aggregation and impersonation cleanup. _(Automated via CI.)_

## Documentation
 - [x] Update worker runbook with new logging/alerting details.
 - [x] Record release notes summarizing worker readiness for Octâ€¯23.
