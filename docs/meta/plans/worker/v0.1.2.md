# Worker v0.1.2 Plan

## Goals
- Power the billing pipeline by aggregating usage signals, rating subscriptions, and generating invoices on a predictable cadence.
- Synchronize payment processor updates (success, failure, dispute) with identity while maintaining audit trails and retry resilience.
- Provide observability into billing jobs so finance/support teams can diagnose issues quickly.

## Scope
1. **Queue Topology & Configuration**
   - Introduce dedicated queues in `apps/worker/src/queue.ts` for `billing.usage`, `billing.invoice`, and `billing.payment-sync`, using constants from `@ma/core`.
   - Update `apps/worker/src/index.ts` to register processors with concurrency tuning and shared context (prisma, identity client, payment adapter).
2. **Usage Aggregation Processors**
   - Build processor module (`apps/worker/src/processors/billing-usage.ts`) that consumes normalized events from identity, batches them, and writes daily/hourly rollups via identity APIs.
   - Handle AI token events by model, ensuring totals align with plan limits; emit alerts via logger when thresholds exceeded.
   - Backfill support: job that can recompute aggregates for a given date range on demand.
3. **Invoice Generation & Rating**
   - Implement `billing-invoice.ts` processor that reads due subscriptions, calculates charges (recurring, usage, overages), and creates invoice records through identity.
   - Support proration, grace periods, and tax calculations using configuration supplied in job payloads.
   - Queue follow-up jobs to send invoice notifications or trigger processor-hosted payment intents as required.
4. **Payment Sync & Webhook Relay**
   - Add processor that retries payment intent confirmations, reconciles status changes, and closes invoices after settlement.
   - Provide handler for payment dispute or refund events, calling identity endpoints to record credit memos and update audit logs.
5. **Telemetry & Alerting**
   - Emit metrics (queue depth, success/failure counts, processing latency) using existing logging hooks; consider Prometheus exporter integration.
   - Publish structured events when invoices fail or when usage ingestion drops messages, to feed future alerting.
6. **Support Scripts & Docs**
   - Extend `apps/worker/src/enqueue.ts` with helpers to trigger backfills or manual invoice generation for testing.
   - Update `docs/operations/runbooks/worker.md` with billing job descriptions, retry guidance, and relevant environment variables.

## Dependencies
- Identity billing APIs and schemas from v0.1.2 plan (`docs/meta/plans/identity/v0.1.2.md`).
- Portal/Admin consumers that rely on fresh usage and invoice data (`docs/meta/plans/portal/v0.1.2.md`, `docs/meta/plans/admin/v0.1.2.md`).
- Payment provider adapter exposed by identity plugins.

## Non-Goals
- Building email delivery for invoices (handled later by notifications pipeline).
- Implementing generalized data lake exports; focus on operational aggregates.
- Real-time streaming dashboards (portal consumes near-real-time aggregates via API instead).

## Deliverables & Milestones
1. **Week 1:** Queue setup, usage aggregation processor scaffold with integration tests.
2. **Week 2:** Invoice rating processor wired to identity, including proration logic.
3. **Week 3:** Payment sync jobs, dispute handling, and manual tooling updates.
4. **Week 4:** Observability polish, runbook updates, and staging dry runs with synthetic data.

## Testing & Quality
- Add Vitest unit tests for aggregation helpers, pricing calculators, and payment sync flows.
- Create integration harness that feeds synthetic usage events and asserts invoice totals against fixtures.
- Run soak test in staging to measure queue throughput and confirm idempotency on retries.

## Rollout Notes
- Deploy behind `WORKER_BILLING_ENABLED` feature flag with staged tenant cohorts; ensure queues are drained before updates.
- Coordinate cutover with identity API release to avoid orphaned jobs.
- After scope completion, bump `apps/worker/package.json` to **0.1.2** and archive plan.
