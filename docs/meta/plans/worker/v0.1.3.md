# Billing v0.1.3 Plan – Worker Service

> This plan rolls up under the billing epic (`docs/meta/plans/epics/billing-epic-v0.1.3.md`).

## Goals
- Ensure billing usage/invoice/payment-sync processors are production ready.
- Provide tooling for backfills and load testing.
- Document operational handoffs for billing queues.

## Scope
1. **Processor Hardening *(Status: ✅ Completed — Oct 2025)***
   - Idempotent billing usage/invoice/payment-sync workers with dedupe job IDs.
   - Logging + metrics for queue throughput and ingestion drops.
2. **Tooling *(Status: ✅ Completed — Oct 2025)***
   - CLI entrypoints: `billing:backfill` and `billing:load-test`.
   - Enqueue script updates supporting historical replay and synthetic load.
3. **Docs *(Status: ✅ Completed — Oct 2025)***
   - Worker runbook updated with billing queues, CLI usage, and monitoring guidance.

## Remaining Work
- [ ] Deferred to v0.1.4 Tasks Launch Readiness: execute the billing load test (`pnpm --filter @ma/worker billing:load-test`) and archive results before GA.

## Dependencies
- Identity service for billing APIs + Stripe provider events.
- Portal/Admin apps consuming aggregates.
- Redis + Postgres capacity sized for billing workloads.

## Rollout Notes
1. Deploy worker alongside identity/portal/admin updates.
2. Verify `WORKER_BILLING_ENABLED` flag before enabling production load.
3. Use `billing:backfill` to replay usage before flipping customer flags.

## Testing & Validation
- Vitest/unit tests for processors.
- Manual dry-run of CLI commands in staging.
- Monitor BullMQ metrics during load test (tracked for deferred execution).
